package opencode

import (
	"fmt"
	"os"
	"path/filepath"
)

// pluginTemplate is the JavaScript plugin that hooks into OpenCode's
// tool.execute.after event and calls claudit store.
const pluginTemplate = `// claudit plugin for OpenCode CLI
// Auto-generated by claudit init --agent=opencode
// Do not edit manually - re-run 'claudit init --agent=opencode' to update

export const ClauditPlugin = async ({ directory }) => {
  return {
    "tool.execute.after": async (event) => {
      const { tool, input, sessionID } = event;

      // Only trigger on shell/bash tool executions containing git commit
      const command = input?.command || input?.cmd || "";
      if (!command.includes("git commit") && !command.includes("git-commit")) {
        return;
      }

      // Find session transcript path
      const dataDir = process.env.OPENCODE_DATA_DIR ||
        (process.platform === "darwin"
          ? process.env.HOME + "/Library/Application Support/opencode"
          : process.env.HOME + "/.local/share/opencode");

      const hookData = JSON.stringify({
        session_id: sessionID || "",
        data_dir: dataDir,
        project_dir: directory,
        tool_name: tool || "",
        tool_input: { command },
      });

      try {
        const { execSync } = await import("child_process");
        execSync("claudit store --agent=opencode", {
          input: hookData,
          cwd: directory,
          timeout: 30000,
          stdio: ["pipe", "pipe", "pipe"],
        });
      } catch (e) {
        // Silently ignore errors to not disrupt workflow
      }
    },
  };
};
`

// InstallPlugin writes the claudit plugin to .opencode/plugins/claudit.js.
func InstallPlugin(repoRoot string) error {
	pluginDir := filepath.Join(repoRoot, ".opencode", "plugins")
	if err := os.MkdirAll(pluginDir, 0755); err != nil {
		return fmt.Errorf("could not create plugin directory: %w", err)
	}

	pluginPath := filepath.Join(pluginDir, "claudit.js")
	if err := os.WriteFile(pluginPath, []byte(pluginTemplate), 0644); err != nil {
		return fmt.Errorf("could not write plugin file: %w", err)
	}

	return nil
}

// HasPlugin checks if the claudit plugin is installed.
func HasPlugin(repoRoot string) bool {
	pluginPath := filepath.Join(repoRoot, ".opencode", "plugins", "claudit.js")
	_, err := os.Stat(pluginPath)
	return err == nil
}
